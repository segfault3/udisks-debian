Description: Mount drives in /media, not /run/media/, to stay FHS compatible. As on Debian and Ubuntu /media is not currently a tmpfs, we need to put the "mounted-fs" file to a persistent path as well.
Author: Martin Pitt <martin.pitt@ubuntu.com>
Bug: https://bugs.freedesktop.org/show_bug.cgi?id=51709
Bug-Debian: http://bugs.debian.org/680403
Bug-Ubuntu: https://launchpad.net/bugs/1020759

Index: udisks2/src/udiskslinuxfilesystem.c
===================================================================
--- udisks2.orig/src/udiskslinuxfilesystem.c	2012-09-06 10:22:25.000000000 +0200
+++ udisks2/src/udiskslinuxfilesystem.c	2012-09-07 15:55:28.775184539 +0200
@@ -859,26 +859,26 @@
     }
 
   /* If we know the user-name and it doesn't have any '/' character in
-   * it, mount in /run/media/$USER
+   * it, mount in /media/$USER
    */
   if (user_name != NULL && strstr (user_name, "/") == NULL)
     {
-      mount_dir = g_strdup_printf ("/run/media/%s", user_name);
+      mount_dir = g_strdup_printf ("/media/%s", user_name);
       if (!g_file_test (mount_dir, G_FILE_TEST_EXISTS))
         {
-          /* First ensure that /run/media exists */
-          if (!g_file_test ("/run/media", G_FILE_TEST_EXISTS))
+          /* First ensure that /media exists */
+          if (!g_file_test ("/media", G_FILE_TEST_EXISTS))
             {
-              if (g_mkdir ("/run/media", 0755) != 0)
+              if (g_mkdir ("/media", 0755) != 0)
                 {
                   g_set_error (error,
                                UDISKS_ERROR,
                                UDISKS_ERROR_FAILED,
-                               "Error creating directory /run/media: %m");
+                               "Error creating directory /media: %m");
                   goto out;
                 }
             }
-          /* Then create the per-user /run/media/$USER */
+          /* Then create the per-user /media/$USER */
           if (g_mkdir (mount_dir, 0700) != 0)
             {
               g_set_error (error,
Index: udisks2/src/udiskscleanup.c
===================================================================
--- udisks2.orig/src/udiskscleanup.c	2012-07-28 13:32:27.617931122 +0200
+++ udisks2/src/udiskscleanup.c	2012-09-07 15:56:57.387188826 +0200
@@ -753,7 +753,7 @@
   /* load existing entries */
   error = NULL;
   value = udisks_persistent_store_get (cleanup->persistent_store,
-                                       UDISKS_PERSISTENT_FLAGS_TEMPORARY_STORE,
+                                       UDISKS_PERSISTENT_FLAGS_NORMAL_STORE,
                                        "mounted-fs",
                                        G_VARIANT_TYPE ("a{sa{sv}}"),
                                        &error);
@@ -790,7 +790,7 @@
     {
       error = NULL;
       if (!udisks_persistent_store_set (cleanup->persistent_store,
-                                        UDISKS_PERSISTENT_FLAGS_TEMPORARY_STORE,
+                                        UDISKS_PERSISTENT_FLAGS_NORMAL_STORE,
                                         "mounted-fs",
                                         G_VARIANT_TYPE ("a{sa{sv}}"),
                                         new_value, /* consumes new_value */
@@ -848,7 +848,7 @@
   /* load existing entries */
   error = NULL;
   value = udisks_persistent_store_get (cleanup->persistent_store,
-                                       UDISKS_PERSISTENT_FLAGS_TEMPORARY_STORE,
+                                       UDISKS_PERSISTENT_FLAGS_NORMAL_STORE,
                                        "mounted-fs",
                                        G_VARIANT_TYPE ("a{sa{sv}}"),
                                        &error);
@@ -913,7 +913,7 @@
   /* save new entries */
   error = NULL;
   if (!udisks_persistent_store_set (cleanup->persistent_store,
-                                    UDISKS_PERSISTENT_FLAGS_TEMPORARY_STORE,
+                                    UDISKS_PERSISTENT_FLAGS_NORMAL_STORE,
                                     "mounted-fs",
                                     G_VARIANT_TYPE ("a{sa{sv}}"),
                                     new_value, /* consumes new_value */
@@ -961,7 +961,7 @@
   /* load existing entries */
   error = NULL;
   value = udisks_persistent_store_get (cleanup->persistent_store,
-                                       UDISKS_PERSISTENT_FLAGS_TEMPORARY_STORE,
+                                       UDISKS_PERSISTENT_FLAGS_NORMAL_STORE,
                                        "mounted-fs",
                                        G_VARIANT_TYPE ("a{sa{sv}}"),
                                        &error);
