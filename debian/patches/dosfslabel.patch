From 75284b7525c5353bd1f9e7a1b59348c8e4f2c189 Mon Sep 17 00:00:00 2001
From: Michael Biebl <biebl@debian.org>
Date: Fri, 24 May 2013 09:03:17 +0200
Subject: [PATCH] Use dosfstools instead of mtools

We already require dosfstools for mkfs.vfat, so just also use it for changing
the fs label.

Bug: https://bugs.freedesktop.org/show_bug.cgi?id=52332
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=680683

Co-Authored-By: Martin Pitt <martin.pitt@ubuntu.com>
---
 src/udiskslinuxfilesystem.c | 13 +++++++++++--
 src/udiskslinuxfsinfo.c     |  4 ++--
 2 files changed, 13 insertions(+), 4 deletions(-)

Index: udisks2/src/udiskslinuxfilesystem.c
===================================================================
--- udisks2.orig/src/udiskslinuxfilesystem.c	2013-08-30 01:59:05.395481692 +0200
+++ udisks2/src/udiskslinuxfilesystem.c	2013-08-30 01:59:05.391481642 +0200
@@ -1817,6 +1817,7 @@
   UDisksBaseJob *job;
   const gchar *action_id;
   const gchar *message;
+  gchar *real_label = NULL;
   uid_t caller_uid;
   gid_t caller_gid;
   pid_t caller_pid;
@@ -1891,8 +1892,9 @@
       goto out;
     }
 
-  /* VFAT does not allow some characters; as mlabel hangs with interactive
-   * question in this case, check in advance */
+  /* VFAT does not allow some characters; as dosfslabel does not enforce this,
+   * check in advance; also, VFAT only knows upper-case characters, dosfslabel
+   * enforces this */
   if (g_strcmp0 (probed_fs_type, "vfat") == 0)
     {
       const gchar *forbidden = "\"*/:<>?\\|";
@@ -1909,6 +1911,11 @@
                goto out;
             }
         }
+
+      /* we need to remember that we make a copy, so assign it to a new
+       * variable, too */
+      real_label = g_ascii_strup (label, -1);
+      label = real_label;
     }
 
   /* Fail if the device is already mounted and the tools/drivers doesn't
@@ -1986,6 +1993,8 @@
                     invocation);
 
  out:
+  /* for some FSes we need to copy and modify label; free our copy */
+  g_free (real_label);
   g_free (command);
   g_clear_object (&object);
   return TRUE; /* returning TRUE means that we handled the method invocation */
Index: udisks2/src/udiskslinuxfsinfo.c
===================================================================
--- udisks2.orig/src/udiskslinuxfsinfo.c	2013-08-30 01:59:05.395481692 +0200
+++ udisks2/src/udiskslinuxfsinfo.c	2013-08-30 01:59:05.391481642 +0200
@@ -53,8 +53,8 @@
     },
     {
       "vfat",
-      "mlabel -i $DEVICE ::$LABEL",
-      "mlabel -i $DEVICE -c ::",
+      "dosfslabel $DEVICE $LABEL",
+      NULL,
       FALSE, /* supports_online_label_rename */
       FALSE, /* supports_owners */
       "mkfs.vfat -I -n $LABEL $DEVICE",
